id: io.github.touchhle.touchHLE
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: touchHLE
finish-args:
  - --share=network
  - --share=ipc
  - --device=all
  - --filesystem=home

modules:
  - name: touchHLE
    buildsystem: simple
    build-options:
      env:
        RUSTUP_TOOLCHAIN: stable
        CARGO_HOME: /run/build/touchHLE/cargo
        CFLAGS: "-Wno-error=incompatible-pointer-types"
        CMAKE_POLICY_VERSION_MINIMUM: "3.5"

    sources:
      # Main source
      - type: archive
        url: https://github.com/touchHLE/touchHLE/archive/refs/tags/v0.2.2.tar.gz
        sha256: AUTO_ADD

      # Patches
      - type: patch
        path: touchhle_cargo_system_sdl2.patch
      - type: patch
        path: touchhle_fhs_paths.patch

      # Git submodules
      - type: archive
        dest: vendor/stb
        url: https://github.com/nothings/stb/archive/9f1776a36d2a3d63c52f705c3a84b372cfed4340.tar.gz
        sha256: AUTO_ADD

      - type: archive
        dest: vendor/dynarmic
        url: https://github.com/touchHLE/dynarmic/archive/76aa4dd665085fb6ac10d4cd58e25466366d0799.tar.gz
        sha256: AUTO_ADD

      - type: archive
        dest: vendor/dr_libs
        url: https://github.com/mackron/dr_libs/archive/dd762b861ecadf5ddd5fb03e9ca1db6707b54fbb.tar.gz
        sha256: AUTO_ADD

    build-commands:
      # --- Apply submodules and patches ---
      - patch -p1 < touchhle_cargo_system_sdl2.patch
      - patch -p1 < touchhle_fhs_paths.patch
      
      # Fetch dependencies
      - cargo fetch --locked

      # Build
      - cargo build --frozen --release --no-default-features

      # Install
      - install -Dm755 target/release/touchHLE /app/bin/touchHLE
      - install -Dm644 CHANGELOG.md /app/share/doc/touchhle/CHANGELOG.md
      - install -Dm644 OPTIONS_HELP.txt /app/share/doc/touchhle/OPTIONS_HELP.txt
      - install -Dm644 README.md /app/share/doc/touchhle/README.md
      - install -Dm644 LICENSE /app/share/licenses/touchhle/LICENSE

      # Install fonts directory
      - install -d /app/share/touchhle/fonts

      # Liberation fonts (symlink system version)
      - ln -s /usr/share/fonts/truetype/liberation/LiberationSans-Bold.ttf /app/share/touchhle/fonts/LiberationSans-Bold.ttf
      - ln -s /usr/share/fonts/truetype/liberation/LiberationSans-Italic.ttf /app/share/touchhle/fonts/LiberationSans-Italic.ttf
      - ln -s /usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf /app/share/touchhle/fonts/LiberationSans-Regular.ttf

      # Copy bundled Noto fonts
      - cp -ar touchHLE_fonts/* /app/share/touchhle/fonts/

      # Install dylibs directory
      - cp -ar touchHLE_dylibs /app/share/touchhle/dylibs

    cleanup:
      - /cargo
      - /root/.cargo
      - '*.a'
      - '*.la'
